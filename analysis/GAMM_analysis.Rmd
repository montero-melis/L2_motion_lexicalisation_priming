---
title: "GAMM analysis"
author: "Guillermo Montero-Melis"
date: "7 februari 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(mgcv)  # GAMs and GAMMs (Wood 2006)
library(itsadug)
library(ggplot2)
# library(lazyeval)  # lazy evaluation used in bysubj() function [summarise_]
# library(lme4)
# library(boot)  # for inv.logit()
# library(knitr)  # for kable()
```


```{r}
# Convenience function

# print deviance explained as percentage
dev_expl <- function(fm) {
  devi <- summary(fm)$dev.expl
  paste(round(100 * devi, 1), "% dev. explained", sep = "")
}
```


## Load data and process

```{r}
#  ------------------------------------------------------------------------
#  Load data
#  ------------------------------------------------------------------------

# The data is created in the script "processing/compute_dependent_measures.R"
# There is the normal and the liberally coded version, see script for difference

# load
d <- read.csv("../data/data_DVs.csv", fileEncoding = "UTF-8", stringsAsFactors = TRUE)
# simplify somewhat
d <- d %>%
  select(Subject:VideoName, P_V, M_V) %>%
  rename(Trial = VideoTrial)
head(d)

# the way to analyze crossed factors seems to be to combine their levels into 
# a single factor, see Wood's comment here
# http://grokbase.com/t/r/r-help/113qaadxt4/r-how-to-add-in-interaction-terms-in-gamm
d$GroupCondit <- with(d, interaction(Group, Condition))

## Data for analysis of Path-priming vs control
dp <- d %>% filter(Condition != "Manner")
dp$GroupCondit <- factor(dp$GroupCondit)
contrasts(dp$GroupCondit)
## Data for analysis of Manner-priming vs control
dm <- d %>% filter(Condition != "Path")
dm$GroupCondit <- factor(dm$GroupCondit)
# note that L2 control becomes the reference group
contrasts(dm$GroupCondit)
```


I largely follow [this tutorial](http://jacolienvanrij.com/Tutorials/GAMM.html) by Jacolien van Rij.


## Some general models

Let us progressively fit more complex models and see how/whether they become better at explaining the data.

```{r}
fm_gen1 <- bam(P_V ~ s(Trial),
              data = d,
              damily = "binomial")
summary(fm_gen1)
```

Of course this model does a rather poor job in explaining the data (`r dev_expl(fm_gen1)`).

```{r}
plot(fm_gen1)
plot_smooth(fm_gen1, view = "Trial")
```


What happens when we add Condition as a predictor, both a linear predictor and allowing the smoother of time to vary as a function of Condition?

```{r}
fm_gen2 <- bam(P_V ~ Condition + s(Trial, by = Condition),
              data = d,
              damily = "binomial")
summary(fm_gen2)
```

The overall fit improves substantially (`r dev_expl(fm_gen2)`).

```{r}
plot_smooth(fm_gen2, view = "Trial", plot_all = "Condition")
```


The next step is to add the interaction of Condition and Group (specified as a single factor that is passed to `by()`):

```{r}
fm_gen3 <- bam(P_V ~ GroupCondit + s(Trial, by = GroupCondit),
              data = d,
              damily = "binomial")
summary(fm_gen3)
plot_smooth(fm_gen3, view = "Trial", plot_all = "GroupCondit")
```

### Add random effects

Allowing subjects to follow different trends over trial does not work, yielding the warning:

```
the matrix is either rank-deficient or indefinite
```

```{r}
# fm_gen4 <- bam(P_V ~ GroupCondit + s(Trial, by = GroupCondit) +
#                  s(Trial, Subject, bs = "fs"),
#               data = d,
#               damily = "binomial")

```

But one can specify Subjects as random effects
(following Winter & Wieling 2016)

```{r}
fm_gen5 <- bam(P_V ~ GroupCondit + s(Trial, by = GroupCondit) +
                 s(Trial, Subject, bs = "re"),
              data = d,
              damily = "binomial")
summary(fm_gen5)
plot_smooth(fm_gen5, view = "Trial", plot_all = "GroupCondit")
plot_smooth(fm_gen5, view = "Trial", plot_all = "GroupCondit", rm.ranef = FALSE)
```



## Do the primed conditions differ from the Control conditions?

This question is addressed separately for Path-verb priming and Manner-verb priming.

In the former, the log-likelihood of choosing a path verb is compared for the two crossed factors:

- Condition: Path-primed vs control
- Group: L2 speakers (L2) vs native speakers (NS)


In the latter, the log-likelihood of choosing a manner verb is compared for the two crossed factors (note different levels in Condition):

- Condition: Manner-primed vs control
- Group: L2 speakers (L2) vs native speakers (NS)



### Path priming


```{r}
fm_p1 <- bam(P_V ~ GroupCondit + s(Trial, by = GroupCondit),
              data = dp,
              damily = "binomial")
summary(fm_p1)
plot_smooth(fm_p1, view = "Trial", plot_all = "GroupCondit")

# and more to the point
plot_diff(fm_p1, view = "Trial", comp = list(GroupCondit = c("NS.Path", "NS.Control")))
plot_diff(fm_p1, view = "Trial", comp = list(GroupCondit = c("L2.Path", "L2.Control")))

```

